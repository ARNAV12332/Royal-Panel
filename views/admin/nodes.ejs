<%- include('../components/template') %>

<main id="content" class="relative min-h-screen z-10">

  <!-- Background -->
  <div class="fixed inset-0 -z-50" style=" z-index: -5;">
    <img src="https://i.pinimg.com/736x/c3/c7/ce/c3c7ce805f89af6489e0d832f0e47205.jpg" 
         class="w-full h-full object-cover"/>
    <div class="absolute inset-0 bg-black/40"></div> <!-- dark overlay for readability -->
  </div>

  <div class="bg-transparent">
    <div class="sm:flex sm:items-center px-8 pt-4">
      <div class="sm:flex-auto">
        <h1 class="text-base font-medium leading-6 text-white"><%= req.translations.nodes %></h1>
        <p class="mt-1 tracking-tight text-sm text-neutral-200"><%= req.translations.nodesText %></p>
      </div>
      <div class="mt-4 sm:ml-16 sm:mt-0 sm:flex-none">
        <div class="flex gap-2">
          <button onclick="radarcheck()" type="button" class="block rounded-xl bg-neutral-900/20 text-neutral-200 border border-white/20 px-3 py-2 text-center text-sm font-medium shadow-lg transition flex gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 256 256"><path d="M240,128a15.74,15.74,0,0,1-7.6,13.51L88.32,229.65a16,16,0,0,1-16.2.3A15.86,15.86,0,0,1,64,216.13V39.87a15.86,15.86,0,0,1,8.12-13.82,16,16,0,0,1,16.2.3L232.4,114.49A15.74,15.74,0,0,1,240,128Z"></path></svg>
            Run Radar Scan
          </button>

          <button id="createButton" type="button" class="block rounded-xl <%= theme['button-color'] %> px-3 py-2 text-center text-sm font-medium shadow-lg transition">
            <%= req.translations.createNewNode %>
          </button>
        </div>
      </div>
    </div>

    <!-- Stats -->
    <div id="stats" class="grid grid-cols-1 md:grid-cols-2 gap-6 m-8">
      <div class="bg-white/20 backdrop-blur-lg border border-white/20 rounded-2xl shadow-lg p-6">
        <h2 class="text-lg font-semibold text-white mb-2">Total Nodes</h2>
        <p class="text-4xl font-bold text-white"><%= nodes.length %></p>
        <p class="text-sm text-neutral-200 mt-2">Online Nodes: <%= nodes.filter(node => node.status === 'Online').length %></p>
      </div>

      <div class="bg-white/20 backdrop-blur-lg border border-white/20 rounded-2xl shadow-lg p-6">
        <h2 class="text-lg font-semibold text-white mb-2">Server Count</h2>
        <p class="text-4xl font-bold text-white"><%= Object.values(set).reduce((a, b) => a + b, 0) %></p>
        <% if (nodes.length > 0) { %>
          <p class="text-sm text-neutral-200 mt-2">Average Node Density: <%= (Object.values(set).reduce((a, b) => a + b, 0) / nodes.length).toFixed(2) %></p>
        <% } else { %>
          <p class="text-sm text-neutral-200 mt-2">No nodes available</p>
        <% } %>
      </div>
    </div>

    <!-- Alerts -->
    <% if (req.query.err == "none") { %>
      <div class="mt-6 w-full">
        <div class="rounded-2xl bg-emerald-800/20 backdrop-blur-lg px-4 py-6 m-8 border border-emerald-500/20">
          <div class="flex">
            <div class="flex-shrink-0 ml-1.5">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 mt-2 text-emerald-400">
                <path fill-rule="evenodd" d="M16.704 4.153a.75.75 0 0 1 .143 1.052l-8 10.5a.75.75 0 0 1-1.127.075l-4.5-4.5a.75.75 0 0 1 1.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 0 1 1.05-.143Z" clip-rule="evenodd" />
              </svg>
            </div>
            <div class="ml-5">
              <h3 class="text-sm font-medium text-emerald-400">Success!</h3>
              <div class="text-sm text-emerald-400/50">
                <p>The action was successfully completed.</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    <% } %>

    <% if (req.query.err == "EDITED") { %>
      <div class="mt-6 w-full">
        <div class="rounded-2xl bg-emerald-800/20 backdrop-blur-lg px-4 py-6 m-8 border border-emerald-500/20">
          <div class="flex">
            <div class="flex-shrink-0 ml-1.5">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 mt-2 text-emerald-400">
                <path fill-rule="evenodd" d="M16.704 4.153a.75.75 0 0 1 .143 1.052l-8 10.5a.75.75 0 0 1-1.127.075l-4.5-4.5a.75.75 0 0 1 1.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 0 1 1.05-.143Z" clip-rule="evenodd" />
              </svg>
            </div>
            <div class="ml-5">
              <h3 class="text-sm font-medium text-emerald-400">Success!</h3>
              <div class="text-sm text-emerald-400/50">
                <p>The node was edited successfully.</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    <% } %>

    <!-- Node Table -->
    <div class="overflow-hidden shadow ring-1 ring-white/10 rounded-2xl m-8 bg-white/20 backdrop-blur-lg border border-white/20" id="nodeTable">
      <table class="min-w-full divide-y divide-white/10">
        <thead class="bg-white/20">
          <tr>
            <th class="py-3.5 pl-4 pr-3 text-left text-sm font-semibold text-white sm:pl-6"><%= req.translations.name %></th>
            <th class="px-3 py-3.5 text-left text-sm font-semibold text-white"><%= req.translations.connection %></th>
            <th class="px-3 py-3.5 text-left text-sm font-semibold text-white"><%= req.translations.instances %></th>
            <th class="px-3 py-3.5 text-left text-sm font-semibold text-white"><%= req.translations.actions %></th>
          </tr>
        </thead>
        <tbody class="divide-y divide-white/5 bg-white/20 text-white">
          <% nodes.forEach(function(node) { %>
            <tr class="hover:bg-white/[0.05] transition-colors clickable-row cursor-pointer" onclick="handleRowClick(event, '/admin/node/<%= node.id %>/stats')">
              <td class="whitespace-nowrap py-4 pl-4 pr-3 text-sm sm:pl-6">
                <div class="flex items-center">
                  <div class="mr-5">
                    <% if (node.status == "Online") { %>
                      <span class="flex h-2 w-2">
                        <span class="animate-ping absolute inline-flex h-2 w-2 rounded-full bg-emerald-400 opacity-75"></span>
                        <span class="relative inline-flex rounded-full h-2 w-2 bg-emerald-500"></span>
                      </span>
                    <% } else if (node.status == "Offline") { %>
                      <span class="flex h-2 w-2">
                        <span class="relative inline-flex rounded-full h-2 w-2 bg-neutral-500"></span>
                      </span>
                    <% } else { %>
                      <span class="flex h-2 w-2">
                        <span class="animate-ping absolute inline-flex h-2 w-2 rounded-full bg-amber-400 opacity-75"></span>
                        <span class="relative inline-flex rounded-full h-2 w-2 bg-amber-500"></span>
                      </span>
                    <% } %>
                  </div>
                  <div class="font-medium text-white"><%= node.name %></div>
                </div>
              </td>
              <td class="whitespace-nowrap px-3 py-4 text-sm">
                <div class="flex">
                  <div class="font-mono text-sm leading-6 mt-1 mr-3 text-neutral-200"><%= node.address %>:<%= node.port %></div>
                  <div class="mt-1 inline-flex items-center rounded-md 
                    <%= node.versionRelease ? 'bg-emerald-600/20 text-emerald-400 ring-emerald-600/20' : 'bg-red-600/20 text-red-400 ring-red-600/20' %> 
                    px-2 py-1 text-xs font-medium ring-1 ring-inset">
                    <%= node.versionRelease || 'unknown' %>
                  </div>                  
                </div>
              </td>
              <td class="whitespace-nowrap px-3 py-4 text-sm text-neutral-200"><%= set[node.id] || 0 %></td>
              <td class="whitespace-nowrap px-3 py-4 text-sm">
                <div class="flex gap-3">
                  <button onclick="configure('<%= node.id %>')" class="rounded-xl <%= theme['button-color'] %> px-3 py-2 text-sm font-medium shadow-lg transition"> <%= req.translations.configure %> </button>
                  <a href="./node/<%= node.id %>">
                    <button class="rounded-xl <%= theme['button-color'] %> px-3 py-2 text-sm font-medium shadow-lg transition"> <%= req.translations.edit %> </button>
                  </a>
                  <button onclick="deletenode('<%= node.id %>')" class="rounded-xl bg-red-600 px-3 py-2 text-sm font-medium text-white shadow-lg hover:bg-red-500 transition"> <%= req.translations.remove %> </button>
                </div>
              </td>
            </tr>
          <% }); %>
        </tbody>
      </table>
    </div>

    <!-- Node Form -->
    <div id="nodeForm" class="mt-6 px-8 w-full hidden">
      <div class="p-6 bg-white/20 backdrop-blur-lg border border-white/20 rounded-2xl shadow-xl sm:p-6 lg:p-10 card" style="width: 800px;">
        <!-- form content unchanged -->
        ...
      </div>
    </div>
  </div>
</main>

<script>
  // JS logic remains unchanged
  async function radarcheck() { ... }
  function handleRowClick(event, url) { ... }
  async function deletenode(nodeId) { ... }
  document.getElementById('createButton').addEventListener('click', function() { ... });
  async function configure(nodeId) { ... }
  function showPopup(command) { ... }
  function setupBadgeInput(inputId, containerId, validator) { ... }
  setupBadgeInput('tagInput', 'tagContainer');
  document.getElementById('createNodeBtn').addEventListener('click', function() { ... });
</script>

<%- include('../components/footer') %>
